<html>
	<head>
		<title>Dina mobile - Selecione a Empresa</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" type="text/css" href="./css/mobile.css">
		<script type="text/javascript" src="./js/global.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	</head>
	<body>
		<div class="limiter">
			<!-- Menu fixado no topo da página -->
			<div class="navbar">
				<!-- Menu hamburger -->
				<a href="" id="menu">
					<div class="menu-hamb"></div>
					<div class="menu-hamb"></div>
					<div class="menu-hamb"></div>
				</a>
				<!-- Ícone do usuário -->
				<a href="" id="icon">
					<div class="user-picture"></div>
				</a>
			</div>
			<div class="container">
				<!-- Título fixado no topo da lista  -->
				<div class="title">Selecione a empresa:</div>
				<!-- Encapsulador de conteúdo  -->
				<div class="content">
					<!-- Lista de empresas que o usuário tem acesso  -->
					<ul class="list">
						<!-- <li class="list-item" data-id="1">
							<div class="img-wrap">
								<img src="./img/300000.png" alt="logo Dinamize" />
							</div>
							<span class="">Dinamize</span>
						</li> -->
					</ul>
				</div>
			</div>
		</div>
	</body>
	<script>
	$(document).ready( function() {
		//BUSCA INFO DO USUARIO
		$.ajax({
		    url: 'http://passport.alexandre.dev.com/user/get',
		    headers: {
		    	"Content-Type": "application/json; charset=utf-8",
		    	"auth-token": sessionStorage.getItem("utoken"),
		    },
		    data: {},
		    type: 'POST',		    
		    success: function(response) {
		    	redirectLogin(response.code);
				$("#user").html(response.body["name"]);
		    },
		    error: function(response) {
		    	console.log('Failed!');
		    	console.log(response);
		    },
		});
		//BUSCA LISTA DE CLIENTES
		$.ajax({
		    url: 'http://passport.alexandre.dev.com/client/search',
		    headers: {
		    	"Content-Type": "application/json; charset=utf-8",
		    	"auth-token": sessionStorage.getItem("utoken"),
		    },
		    data: {},
		    type: 'POST',		    
		    success: function(response) {
				var listaClientes = response.body["items"];
				$(".list").html("");
				for(x in listaClientes){
					var client_code = listaClientes[x]["client_code"];
					var client_name = listaClientes[x]["trade_name"];
					$(".list").append("<li class='list-item' data-code='"+client_code+"' data-name='"+client_name+"'>" +
						"<div class='img-wrap'>" +
							"<span class='helper'></span><img src='./img/"+client_code+".png' alt='"+client_name+"' />" +
						"</div>" +
						"<span class=''>"+client_name+"</span>" +
					"</li>");
			    }
		    },
		    error: function(response) {
				console.log('Failed!');
				console.log(response);
		    },
		});

		// Listener de seleção para cada Cliente
		$('.list').on('click', '.list-item', function() {
			client_code = $(this).attr('data-code');
			client_name = $(this).attr('data-name')
			// Request para conseguir a outra parte do token ---------------
			$.ajax({
				url: 'http://passport.alexandre.dev.com/client/token',
				headers: {
			    	"Content-Type": "application/json; charset=utf-8",
			    	"auth-token": sessionStorage.getItem("utoken"),
			    },
			    data: JSON.stringify({"client_code": client_code}),
			    type: 'POST',
			    success: function(response) {
		    		redirectLogin(response.code);
					if (response["body"] && response["body"]["auth-token"]) {
						sessionStorage.setItem("utoken", response["body"]["auth-token"]);
						sessionStorage.setItem("products", JSON.stringify(response["body"]["products"]));
						sessionStorage.setItem("client_code", client_code);
						sessionStorage.setItem("client_name", client_name);
						$(location).attr('href', 'products.html');
					}
				},
				error: function(response) {
					console.log('Failed!');
					console.log(response);
				},
			});
		});
	});
</script>
</html>